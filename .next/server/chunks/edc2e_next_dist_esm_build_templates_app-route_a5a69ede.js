module.exports=[22504,e=>{"use strict";var t=e.i(40460),a=e.i(64747),r=e.i(39250),n=e.i(19326),i=e.i(43547),o=e.i(94922),l=e.i(11985),s=e.i(50529),c=e.i(8187),u=e.i(89920),d=e.i(69543),p=e.i(19469),h=e.i(71884),g=e.i(92572),m=e.i(2657),f=e.i(939),E=e.i(93695);e.i(12859);var R=e.i(38928),y=e.i(67442),S=e.i(63217);class w{priceData=[];earningsData=[];peRatios=[];async fetchHistoricalPrices(e,t,a,r="1d"){try{console.log(`Fetching historical prices for ${e}...`);let n=(await S.default.chart(e,{period1:t,period2:a,interval:r})).quotes||[];return this.priceData=n.map(e=>({date:new Date(e.date),open:e.open||0,high:e.high||0,low:e.low||0,close:e.close||0,volume:e.volume||0,adjClose:e.adjclose||e.close||0})),console.log(`Fetched ${this.priceData.length} price data points`),this.priceData}catch(e){throw console.error("Error fetching historical prices:",e),e}}async fetchEarningsData(e){try{console.log(`Fetching earnings data for ${e}...`);let t=null;try{let a=await S.default.quoteSummary(e,{modules:["incomeStatementHistoryQuarterly"]});if(a?.incomeStatementHistoryQuarterly){let e=a.incomeStatementHistoryQuarterly.incomeStatementHistory||a.incomeStatementHistoryQuarterly;Array.isArray(e)&&e.length>0&&(t={quarterly:e,type:"quarterly"})}}catch(e){console.log("Quarterly earnings fetch error")}if(!t)try{let a=await S.default.quoteSummary(e,{modules:["incomeStatementHistory"]});if(a?.incomeStatementHistory){let e=a.incomeStatementHistory.incomeStatementHistory||a.incomeStatementHistory;Array.isArray(e)&&e.length>0&&(t={annual:e,type:"annual"})}}catch(e){console.log("Annual earnings fetch error")}if(!t)throw Error("Could not fetch earnings data");return this.earningsData=this.processEarningsData(t),console.log(`Processed ${this.earningsData.length} earnings periods`),this.earningsData}catch(e){throw console.error("Error fetching earnings data:",e),e}}async fetchCurrentEPSFallback(e){try{console.log("Using Fallback Method: Current TTM EPS");let t=await S.default.quoteSummary(e,{modules:["defaultKeyStatistics","financialData"]}),a=null;if(t.defaultKeyStatistics?.trailingEps?.raw?a=t.defaultKeyStatistics.trailingEps.raw:t.financialData?.earningsPerShare?.raw&&(a=t.financialData.earningsPerShare.raw),a&&a>0)return this.earningsData=[{date:new Date("2020-01-01"),eps:a,period:"ttm_current"}],console.log(`Created fallback earnings data with TTM EPS: ${a}`),!0;return!1}catch(e){return console.log("Fallback method failed"),!1}}processEarningsData(e){let t=[];return"quarterly"===e.type&&e.quarterly?t=e.quarterly.map(e=>({date:e.endDate?.raw?new Date(1e3*e.endDate.raw):null,eps:e.basicEPS?.raw||e.dilutedEPS?.raw||null,period:"quarterly"})).filter(e=>e.date&&null!==e.eps):"annual"===e.type&&e.annual&&(t=e.annual.map(e=>({date:e.endDate?.raw?new Date(1e3*e.endDate.raw):null,eps:e.basicEPS?.raw||e.dilutedEPS?.raw||null,period:"annual"})).filter(e=>e.date&&null!==e.eps)),t.sort((e,t)=>e.date.getTime()-t.date.getTime())}calculateTTMEPS(e){let t=this.earningsData.filter(t=>t.date<=e&&null!==t.eps).sort((e,t)=>t.date.getTime()-e.date.getTime());if(0===t.length)return null;if("quarterly"===t[0].period){if(t.length<4){if(t.length>=2){let e=t.slice(0,Math.min(4,t.length)),a=e.reduce((e,t)=>e+t.eps,0);return e.length<4&&(a=4*(a/e.length)),a}return null}return t.slice(0,4).reduce((e,t)=>e+t.eps,0)}return"annual"===t[0].period?t[0].eps:null}calculateHistoricalPE(){if(console.log("Calculating historical PE ratios..."),0===this.earningsData.length)return console.log("No earnings data available for PE calculation"),[];this.peRatios=this.priceData.map(e=>{let t=this.calculateTTMEPS(e.date),a=null;return t&&t>0&&(a=e.adjClose/t),{date:e.date,price:e.adjClose,ttmEPS:t,peRatio:a}});let e=this.peRatios.filter(e=>null!==e.peRatio);return console.log(`Calculated ${e.length} valid PE ratios out of ${this.peRatios.length} price points`),this.peRatios}getPEStatistics(){let e=this.peRatios.filter(e=>null!==e.peRatio).map(e=>e.peRatio);if(0===e.length)return null;let t=e.sort((e,t)=>e-t),a=Math.min(...e),r=Math.max(...e),n=e.reduce((e,t)=>e+t,0)/e.length,i=t[Math.floor(t.length/2)];return{count:e.length,min:a,max:r,average:n,median:i,current:this.peRatios[this.peRatios.length-1]?.peRatio||null}}exportToCSV(){let e=["Date,Price,TTM_EPS,PE_Ratio"];return this.peRatios.forEach(t=>{let a=[t.date.toISOString().split("T")[0],t.price?.toFixed(2)||"",t.ttmEPS?.toFixed(4)||"",t.peRatio?.toFixed(2)||""];e.push(a.join(","))}),e.join("\n")}async calculateHistoricalPEForStock(e,t,a,r="1mo"){try{if(console.log(`
=== Calculating Historical PE Ratios for ${e} ===`),console.log(`Period: ${t} to ${a}`),console.log(`Interval: ${r}
`),await this.fetchHistoricalPrices(e,t,a,r),await this.fetchEarningsData(e),0===this.earningsData.length&&(console.log("\nNo detailed earnings data available, trying fallback method..."),!await this.fetchCurrentEPSFallback(e)))throw Error("Could not obtain any EPS data for PE calculation");this.calculateHistoricalPE();let n=this.getPEStatistics();return n&&(console.log("\n=== PE Ratio Statistics ==="),console.log(`Valid data points: ${n.count}`),console.log(`Current PE: ${n.current?.toFixed(2)||"N/A"}`),console.log(`Average PE: ${n.average.toFixed(2)}`),console.log(`Median PE: ${n.median.toFixed(2)}`),console.log(`Min PE: ${n.min.toFixed(2)}`),console.log(`Max PE: ${n.max.toFixed(2)}`)),{priceData:this.priceData,earningsData:this.earningsData,peRatios:this.peRatios,statistics:n}}catch(e){throw console.error("Error in calculateHistoricalPEForStock:",e),e}}}async function P(e,{params:t}){try{let{symbol:a}=t,{searchParams:r}=new URL(e.url),n=r.get("startDate"),i=r.get("endDate"),o=r.get("interval")||"1mo";if(!n||!i)return y.NextResponse.json({success:!1,error:"startDate and endDate parameters are required",code:"MISSING_PARAMS",timestamp:new Date().toISOString()},{status:400});let l=new w,s=await l.calculateHistoricalPEForStock(a,n,i,o);return y.NextResponse.json({success:!0,symbol:a,period:{start:n,end:i},interval:o,statistics:s.statistics,dataPoints:s.peRatios.length,data:s.peRatios.map(e=>({date:e.date.toISOString().split("T")[0],price:e.price,ttmEPS:e.ttmEPS,peRatio:e.peRatio})),timestamp:new Date().toISOString()})}catch(e){return y.NextResponse.json({success:!1,error:e.message||"Failed to calculate P/E ratios",code:"PE_RATIO_ERROR",timestamp:new Date().toISOString()},{status:500})}}S.default.suppressNotices(["ripHistorical","yahooSurvey"]),e.s(["GET",()=>P],70097);var v=e.i(70097);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/stocks/pe-ratio/[symbol]/route",pathname:"/api/stocks/pe-ratio/[symbol]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/stocks/pe-ratio/[symbol]/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:C,workUnitAsyncStorage:x,serverHooks:T}=D;function A(){return(0,r.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:x})}async function b(e,t,r){D.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/stocks/pe-ratio/[symbol]/route";y=y.replace(/\/index$/,"")||"/";let S=await D.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:P,nextConfig:v,parsedUrl:C,isDraftMode:x,prerenderManifest:T,routerServerContext:A,isOnDemandRevalidate:b,revalidateOnlyGenerated:H,resolvedPathname:M,clientReferenceManifest:N,serverActionsManifest:O}=S,F=(0,s.normalizeAppPath)(y),k=!!(T.dynamicRoutes[F]||T.routes[M]),q=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,C,!1):t.end("This page could not be found"),null);if(k&&!x){let e=!!T.routes[M],t=T.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await q();throw new E.NoFallbackError}}let $=null;!k||D.isDev||x||($="/index"===($=M)?"/":$);let _=!0===D.isDev||!k,I=k&&!_;O&&N&&(0,o.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:N,serverActionsManifest:O,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:O})});let U=e.method||"GET",j=(0,i.getTracer)(),K=j.getActiveScopeSpan(),L={params:P,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>D.onRequestError(e,t,r,A)},sharedContext:{buildId:w}},B=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),Q=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let o=async e=>D.handle(Q,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${y}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var i,s;let c=async({previousCacheEntry:a})=>{try{if(!l&&b&&H&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let s=L.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let c=L.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(B,G,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,r=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:b})},A),t}},u=await D.handleResponse({req:e,nextConfig:v,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:H,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!k)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(s=u.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&k||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,G,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};K?await s(K):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},s))}catch(t){if(t instanceof E.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:b})}),k)throw t;return await (0,h.sendResponse)(B,G,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>A,"routeModule",()=>D,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>x],22504)}];

//# sourceMappingURL=edc2e_next_dist_esm_build_templates_app-route_a5a69ede.js.map